<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.29">
    <title>gRPC | PPG007 的文档</title><meta name="description" content="PPG007 的站点">
    <link rel="modulepreload" href="/assets/app.269ed0ef.js"><link rel="modulepreload" href="/assets/grpc.html.a632298e.js"><link rel="modulepreload" href="/assets/grpc.html.ada5a1b5.js">
    <link rel="stylesheet" href="/assets/style.ffa2e7b7.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header ref_key="navbar" class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/" class=""><!----><span class="site-name can-hide">PPG007 的文档</span></a></span><div class="navbar-links-wrapper" style=""><!--[--><!--]--><nav class="navbar-links can-hide"><!--[--><div class="navbar-links-item"><a href="/" class="nav-link" aria-label="首页"><!--[--><!--]--> 首页 <!--[--><!--]--></a></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="前端"><span class="title">前端</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="前端"><span class="title">前端</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/html" class="nav-link" aria-label="HTML"><!--[--><!--]--> HTML <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/css" class="nav-link" aria-label="CSS"><!--[--><!--]--> CSS <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/javascript" class="nav-link" aria-label="JavaScript"><!--[--><!--]--> JavaScript <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/es6" class="nav-link" aria-label="ES6"><!--[--><!--]--> ES6 <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/vue2" class="nav-link" aria-label="Vue 2.X"><!--[--><!--]--> Vue 2.X <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/vue3" class="nav-link" aria-label="Vue 3"><!--[--><!--]--> Vue 3 <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/axios" class="nav-link" aria-label="Axios"><!--[--><!--]--> Axios <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/dart" class="nav-link" aria-label="Dart"><!--[--><!--]--> Dart <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="Java"><span class="title">Java</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="Java"><span class="title">Java</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/javaio" class="nav-link" aria-label="Java IO"><!--[--><!--]--> Java IO <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/javaknowledge" class="nav-link" aria-label="Java 知识点"><!--[--><!--]--> Java 知识点 <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/javanet" class="nav-link" aria-label="Java 网络通信"><!--[--><!--]--> Java 网络通信 <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/javathread" class="nav-link" aria-label="Java 多线程"><!--[--><!--]--> Java 多线程 <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/annotation-and-reflection" class="nav-link" aria-label="Java 注解和反射"><!--[--><!--]--> Java 注解和反射 <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/activemq" class="nav-link" aria-label="ActiveMQ"><!--[--><!--]--> ActiveMQ <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/mybatis" class="nav-link" aria-label="Mybatis"><!--[--><!--]--> Mybatis <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/spring" class="nav-link" aria-label="Spring"><!--[--><!--]--> Spring <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/SpringMVC" class="nav-link" aria-label="SpringMVC"><!--[--><!--]--> SpringMVC <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/SpringBoot" class="nav-link" aria-label="SpringBoot"><!--[--><!--]--> SpringBoot <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/SpringCloud" class="nav-link" aria-label="SpringCloud"><!--[--><!--]--> SpringCloud <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/dubbo" class="nav-link" aria-label="Dubbo"><!--[--><!--]--> Dubbo <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/netty" class="nav-link" aria-label="Netty"><!--[--><!--]--> Netty <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="Go"><span class="title">Go</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="Go"><span class="title">Go</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/go" class="nav-link" aria-label="Go"><!--[--><!--]--> Go <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/grpc-and-protobuf" class="nav-link router-link-active" aria-label="gRPC&amp;Protobuf"><!--[--><!--]--> gRPC&amp;Protobuf <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/gin" class="nav-link" aria-label="Gin"><!--[--><!--]--> Gin <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="数据库"><span class="title">数据库</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="数据库"><span class="title">数据库</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/mongodb" class="nav-link" aria-label="MongoDB"><!--[--><!--]--> MongoDB <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/redis" class="nav-link" aria-label="Redis"><!--[--><!--]--> Redis <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="Git"><span class="title">Git</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="Git"><span class="title">Git</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/git" class="nav-link" aria-label="Git"><!--[--><!--]--> Git <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="云相关"><span class="title">云相关</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="云相关"><span class="title">云相关</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/docker" class="nav-link" aria-label="Docker"><!--[--><!--]--> Docker <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/kubernetes" class="nav-link" aria-label="Kubernetes"><!--[--><!--]--> Kubernetes <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/istio" class="nav-link" aria-label="Istio"><!--[--><!--]--> Istio <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/domain" class="nav-link" aria-label="域名获取及 CA 认证"><!--[--><!--]--> 域名获取及 CA 认证 <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="others"><span class="title">others</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="others"><span class="title">others</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/codingstyle" class="nav-link" aria-label="Coding Style"><!--[--><!--]--> Coding Style <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/clean-code" class="nav-link" aria-label="Clean Code"><!--[--><!--]--> Clean Code <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/markdown" class="nav-link" aria-label="Markdown"><!--[--><!--]--> Markdown <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/vscode" class="nav-link" aria-label="VsCode"><!--[--><!--]--> VsCode <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/restful" class="nav-link" aria-label="Restful API"><!--[--><!--]--> Restful API <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/regex" class="nav-link" aria-label="正则表达式"><!--[--><!--]--> 正则表达式 <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/zookeeper" class="nav-link" aria-label="ZooKeeper"><!--[--><!--]--> ZooKeeper <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/design-pattern" class="nav-link" aria-label="设计模式"><!--[--><!--]--> 设计模式 <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/ubuntu-20.04-init" class="nav-link" aria-label="Ubuntu20.04初始化清单"><!--[--><!--]--> Ubuntu20.04初始化清单 <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/openwrt" class="nav-link" aria-label="搭建软路由"><!--[--><!--]--> 搭建软路由 <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-links-item"><a class="nav-link external" href="https://github.com/PPG007/PPG007.github.io" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-dark-button" title="toggle dark mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><form class="search-box" role="search"><input type="search" placeholder="Search" autocomplete="off" spellcheck="false" value><!----></form></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-links"><!--[--><div class="navbar-links-item"><a href="/" class="nav-link" aria-label="首页"><!--[--><!--]--> 首页 <!--[--><!--]--></a></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="前端"><span class="title">前端</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="前端"><span class="title">前端</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/html" class="nav-link" aria-label="HTML"><!--[--><!--]--> HTML <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/css" class="nav-link" aria-label="CSS"><!--[--><!--]--> CSS <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/javascript" class="nav-link" aria-label="JavaScript"><!--[--><!--]--> JavaScript <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/es6" class="nav-link" aria-label="ES6"><!--[--><!--]--> ES6 <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/vue2" class="nav-link" aria-label="Vue 2.X"><!--[--><!--]--> Vue 2.X <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/vue3" class="nav-link" aria-label="Vue 3"><!--[--><!--]--> Vue 3 <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/axios" class="nav-link" aria-label="Axios"><!--[--><!--]--> Axios <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/dart" class="nav-link" aria-label="Dart"><!--[--><!--]--> Dart <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="Java"><span class="title">Java</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="Java"><span class="title">Java</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/javaio" class="nav-link" aria-label="Java IO"><!--[--><!--]--> Java IO <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/javaknowledge" class="nav-link" aria-label="Java 知识点"><!--[--><!--]--> Java 知识点 <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/javanet" class="nav-link" aria-label="Java 网络通信"><!--[--><!--]--> Java 网络通信 <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/javathread" class="nav-link" aria-label="Java 多线程"><!--[--><!--]--> Java 多线程 <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/annotation-and-reflection" class="nav-link" aria-label="Java 注解和反射"><!--[--><!--]--> Java 注解和反射 <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/activemq" class="nav-link" aria-label="ActiveMQ"><!--[--><!--]--> ActiveMQ <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/mybatis" class="nav-link" aria-label="Mybatis"><!--[--><!--]--> Mybatis <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/spring" class="nav-link" aria-label="Spring"><!--[--><!--]--> Spring <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/SpringMVC" class="nav-link" aria-label="SpringMVC"><!--[--><!--]--> SpringMVC <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/SpringBoot" class="nav-link" aria-label="SpringBoot"><!--[--><!--]--> SpringBoot <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/SpringCloud" class="nav-link" aria-label="SpringCloud"><!--[--><!--]--> SpringCloud <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/dubbo" class="nav-link" aria-label="Dubbo"><!--[--><!--]--> Dubbo <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/netty" class="nav-link" aria-label="Netty"><!--[--><!--]--> Netty <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="Go"><span class="title">Go</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="Go"><span class="title">Go</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/go" class="nav-link" aria-label="Go"><!--[--><!--]--> Go <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/grpc-and-protobuf" class="nav-link router-link-active" aria-label="gRPC&amp;Protobuf"><!--[--><!--]--> gRPC&amp;Protobuf <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/gin" class="nav-link" aria-label="Gin"><!--[--><!--]--> Gin <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="数据库"><span class="title">数据库</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="数据库"><span class="title">数据库</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/mongodb" class="nav-link" aria-label="MongoDB"><!--[--><!--]--> MongoDB <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/redis" class="nav-link" aria-label="Redis"><!--[--><!--]--> Redis <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="Git"><span class="title">Git</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="Git"><span class="title">Git</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/git" class="nav-link" aria-label="Git"><!--[--><!--]--> Git <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="云相关"><span class="title">云相关</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="云相关"><span class="title">云相关</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/docker" class="nav-link" aria-label="Docker"><!--[--><!--]--> Docker <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/kubernetes" class="nav-link" aria-label="Kubernetes"><!--[--><!--]--> Kubernetes <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/istio" class="nav-link" aria-label="Istio"><!--[--><!--]--> Istio <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/domain" class="nav-link" aria-label="域名获取及 CA 认证"><!--[--><!--]--> 域名获取及 CA 认证 <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="others"><span class="title">others</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="others"><span class="title">others</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/codingstyle" class="nav-link" aria-label="Coding Style"><!--[--><!--]--> Coding Style <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/clean-code" class="nav-link" aria-label="Clean Code"><!--[--><!--]--> Clean Code <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/markdown" class="nav-link" aria-label="Markdown"><!--[--><!--]--> Markdown <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/vscode" class="nav-link" aria-label="VsCode"><!--[--><!--]--> VsCode <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/restful" class="nav-link" aria-label="Restful API"><!--[--><!--]--> Restful API <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/regex" class="nav-link" aria-label="正则表达式"><!--[--><!--]--> 正则表达式 <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/zookeeper" class="nav-link" aria-label="ZooKeeper"><!--[--><!--]--> ZooKeeper <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/design-pattern" class="nav-link" aria-label="设计模式"><!--[--><!--]--> 设计模式 <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/ubuntu-20.04-init" class="nav-link" aria-label="Ubuntu20.04初始化清单"><!--[--><!--]--> Ubuntu20.04初始化清单 <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/openwrt" class="nav-link" aria-label="搭建软路由"><!--[--><!--]--> 搭建软路由 <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-links-item"><a class="nav-link external" href="https://github.com/PPG007/PPG007.github.io" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-links"><!--[--><!--[--><p class="sidebar-heading sidebar-item active">gRPC&amp;Protobuf</p><ul class=""><li><!--[--><a href="/grpc-and-protobuf/docs/protobuf.html" class="nav-link sidebar-item" aria-label="ProtoBuf"><!--[--><!--]--> ProtoBuf <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/grpc-and-protobuf/docs/grpc.html" class="router-link-active router-link-exact-active nav-link router-link-active sidebar-item active" aria-label="gRPC"><!--[--><!--]--> gRPC <!--[--><!--]--></a><ul class="sidebar-sub-items"><li><!--[--><a aria-current="page" href="/grpc-and-protobuf/docs/grpc.html#引入-grpc" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="引入 gRPC"><!--[--><!--]--> 引入 gRPC <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/grpc-and-protobuf/docs/grpc.html#一元-rpc" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="一元 RPC"><!--[--><!--]--> 一元 RPC <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/grpc-and-protobuf/docs/grpc.html#服务端流式-rpc" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="服务端流式 RPC"><!--[--><!--]--> 服务端流式 RPC <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/grpc-and-protobuf/docs/grpc.html#客户端流式-rpc" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="客户端流式 RPC"><!--[--><!--]--> 客户端流式 RPC <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/grpc-and-protobuf/docs/grpc.html#双向流式-rpc" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="双向流式 RPC"><!--[--><!--]--> 双向流式 RPC <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/grpc-and-protobuf/docs/grpc.html#metadata、interceptor、jwt" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="metadata、interceptor、JWT"><!--[--><!--]--> metadata、interceptor、JWT <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/grpc-and-protobuf/docs/grpc.html#ssl-tls" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="SSL TLS"><!--[--><!--]--> SSL TLS <!--[--><!--]--></a><ul class="sidebar-sub-items"><li><!--[--><a aria-current="page" href="/grpc-and-protobuf/docs/grpc.html#服务端认证" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="服务端认证"><!--[--><!--]--> 服务端认证 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/grpc-and-protobuf/docs/grpc.html#双端认证" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="双端认证"><!--[--><!--]--> 双端认证 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><a aria-current="page" href="/grpc-and-protobuf/docs/grpc.html#load-balance" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="Load Balance"><!--[--><!--]--> Load Balance <!--[--><!--]--></a><ul class="sidebar-sub-items"><li><!--[--><a aria-current="page" href="/grpc-and-protobuf/docs/grpc.html#no-tls" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="NO TLS"><!--[--><!--]--> NO TLS <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/grpc-and-protobuf/docs/grpc.html#tls" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="TLS"><!--[--><!--]--> TLS <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><a aria-current="page" href="/grpc-and-protobuf/docs/grpc.html#grpc-gateway" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="gRPC Gateway"><!--[--><!--]--> gRPC Gateway <!--[--><!--]--></a><ul class="sidebar-sub-items"><li><!--[--><a aria-current="page" href="/grpc-and-protobuf/docs/grpc.html#安装工具" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="安装工具"><!--[--><!--]--> 安装工具 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/grpc-and-protobuf/docs/grpc.html#在服务-proto-文件中定义" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="在服务 proto 文件中定义"><!--[--><!--]--> 在服务 proto 文件中定义 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/grpc-and-protobuf/docs/grpc.html#在-yaml-配置文件中定义" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="在 YAML 配置文件中定义"><!--[--><!--]--> 在 YAML 配置文件中定义 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/grpc-and-protobuf/docs/grpc.html#tls-1" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="TLS"><!--[--><!--]--> TLS <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><a aria-current="page" href="/grpc-and-protobuf/docs/grpc.html#结合自定义-tag-实现-validate" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="结合自定义 tag 实现 validate"><!--[--><!--]--> 结合自定义 tag 实现 validate <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li></ul><!--]--><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><h1 id="grpc" tabindex="-1"><a class="header-anchor" href="#grpc" aria-hidden="true">#</a> gRPC</h1><div class="custom-container tip"><p class="custom-container-title">TIP</p><p>可以使用以下命令生成桩文件：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>docker run --rm --name protoc --mount <span class="token assign-left variable">type</span><span class="token operator">=</span>bind,source<span class="token operator">=</span><span class="token variable">${your protofile abs path}</span>,target<span class="token operator">=</span>/app/proto ppg007/protoc-gen:latest /sbin/my_init -- <span class="token function">ls</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>此种方式下，proto 源文件夹必须是绝对路径，且最多允许两层嵌套，例：如果输入的源路径为 /home/user/proto，那么 proto 文件夹中可以直接存放 proto 文件，也可以在 proto 文件夹中创建多个子目录存放 proto 文件。</p><p>如果使用的 grpc-gateway 是使用 yaml 格式描述的，这个 yaml 文件名必须是 <code>service.yml</code>。</p><p>此镜像详细信息见：<a href="https://github.com/PPG007/protoc-gen" target="_blank" rel="noopener noreferrer">protoc-gen<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a></p></div><h2 id="引入-grpc" tabindex="-1"><a class="header-anchor" href="#引入-grpc" aria-hidden="true">#</a> 引入 gRPC</h2><p><code>go get google.golang.org/grpc</code>。</p><h2 id="一元-rpc" tabindex="-1"><a class="header-anchor" href="#一元-rpc" aria-hidden="true">#</a> 一元 RPC</h2><p>在 proto 文件编译后生成的代码中可以找到 proto 中 service 关键字定义的接口 interface：</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">type</span> LaptopServiceServer <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">CreateLaptop</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> <span class="token operator">*</span>CreateLaptopRequest<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>CreateLaptopResponse<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
	<span class="token function">mustEmbedUnimplementedLaptopServiceServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>在生成的接口中存在一个对包外不可见的方法，同时这个生成的文件提供了一个结构体 <code>UnimplementedLaptopServiceServer</code> 实现了这个接口的所有方法，如果我们要在其他包中实现这个接口，就必须在包外的结构体中：</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">type</span> LaptopServer <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  <span class="token comment">// 自定义的接口，用来保存笔记本，这里直接保存在一个 map 中。</span>
	LaptopStore LaptopStore
  <span class="token comment">// 自定义的接口，用来保存图片，这里保存在系统中指定的路径中。</span>
	ImageStore  ImageStore
  <span class="token comment">// 匿名嵌套</span>
	pb<span class="token punctuation">.</span>UnimplementedLaptopServiceServer
  <span class="token comment">// 自定义接口，用来保存笔记本的评分，这里直接存在 map 中。</span>
	RatingStore RatingStore
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>在上面的结构体上实现这个接口：</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>server <span class="token operator">*</span>LaptopServer<span class="token punctuation">)</span> <span class="token function">CreateLaptop</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> req <span class="token operator">*</span>pb<span class="token punctuation">.</span>CreateLaptopRequest<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>pb<span class="token punctuation">.</span>CreateLaptopResponse<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 获取请求中的 laptop 对象</span>
	laptop <span class="token operator">:=</span> req<span class="token punctuation">.</span><span class="token function">GetLaptop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;receive a create-laptop request with id: %s&quot;</span><span class="token punctuation">,</span> laptop<span class="token punctuation">.</span>Id<span class="token punctuation">)</span>
  <span class="token comment">// 如果传来的 laptop 的 id 大于 0 就对其进行验证。</span>
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>laptop<span class="token punctuation">.</span>Id<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
    <span class="token comment">// 使用 uuid 解析 id</span>
		<span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> uuid<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>laptop<span class="token punctuation">.</span>Id<span class="token punctuation">)</span>
    <span class="token comment">// 如果出错就直接返回</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> status<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span>codes<span class="token punctuation">.</span>InvalidArgument<span class="token punctuation">,</span> <span class="token string">&quot;laptop ID is not a valid UUID: %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果发来的 laptop 的 id 长度为 0，就生成一个随机 id 赋值给这个 laptop 对象。</span>
		id<span class="token punctuation">,</span> err <span class="token operator">:=</span> uuid<span class="token punctuation">.</span><span class="token function">NewRandom</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 出错就返回。</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> status<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span>codes<span class="token punctuation">.</span>Internal<span class="token punctuation">,</span> <span class="token string">&quot;cannot generate a new laptop ID: %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		laptop<span class="token punctuation">.</span>Id <span class="token operator">=</span> id<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
  <span class="token comment">// 如果客户端终止了（Ctrl + C）就直接返回错误。</span>
	<span class="token keyword">if</span> ctx<span class="token punctuation">.</span><span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> context<span class="token punctuation">.</span>Canceled <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;request canceled&quot;</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> status<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>codes<span class="token punctuation">.</span>Canceled<span class="token punctuation">,</span> <span class="token string">&quot;request canceled&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
  <span class="token comment">// 如果客户端设置了超时且已经超时也返回错误。</span>
	<span class="token keyword">if</span> ctx<span class="token punctuation">.</span><span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> context<span class="token punctuation">.</span>DeadlineExceeded <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;deadline exceeded&quot;</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> status<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>codes<span class="token punctuation">.</span>DeadlineExceeded<span class="token punctuation">,</span> <span class="token string">&quot;deadling exceeded&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
  <span class="token comment">// 将这个 laptop 保存起来并对错误进行处理。</span>
	err <span class="token operator">:=</span> server<span class="token punctuation">.</span>LaptopStore<span class="token punctuation">.</span><span class="token function">Save</span><span class="token punctuation">(</span>laptop<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		s<span class="token punctuation">,</span> ok <span class="token operator">:=</span> status<span class="token punctuation">.</span><span class="token function">FromError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
		<span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> status<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span>codes<span class="token punctuation">.</span>Internal<span class="token punctuation">,</span> <span class="token string">&quot;cannot save laptop to the store: %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> status<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">Code</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;cannot save laptop to the store: %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>pb<span class="token punctuation">.</span>CreateLaptopResponse<span class="token punctuation">{</span>
		Id<span class="token punctuation">:</span> laptop<span class="token punctuation">.</span>Id<span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br></div></div><p>服务端启动函数：</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	port <span class="token operator">:=</span> flag<span class="token punctuation">.</span><span class="token function">Int</span><span class="token punctuation">(</span><span class="token string">&quot;port&quot;</span><span class="token punctuation">,</span> <span class="token number">8080</span><span class="token punctuation">,</span> <span class="token string">&quot;the server port&quot;</span><span class="token punctuation">)</span>
	flag<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;start server on port %d\n&quot;</span><span class="token punctuation">,</span> <span class="token operator">*</span>port<span class="token punctuation">)</span>
	laptopServer <span class="token operator">:=</span> service<span class="token punctuation">.</span><span class="token function">NewLaptopServer</span><span class="token punctuation">(</span>service<span class="token punctuation">.</span><span class="token function">NewInMemoryLaptopStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token comment">// 创建一个 grpc 服务器。</span>
	grpcServer <span class="token operator">:=</span> grpc<span class="token punctuation">.</span><span class="token function">NewServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">// 向这个 grpc 服务器注册一个服务。</span>
	pb<span class="token punctuation">.</span><span class="token function">RegisterLaptopServiceServer</span><span class="token punctuation">(</span>grpcServer<span class="token punctuation">,</span> laptopServer<span class="token punctuation">)</span>
	address <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;0.0.0.0:%d&quot;</span><span class="token punctuation">,</span> <span class="token operator">*</span>port<span class="token punctuation">)</span>
  <span class="token comment">// 定义监听。</span>
	listener<span class="token punctuation">,</span> err <span class="token operator">:=</span> net<span class="token punctuation">.</span><span class="token function">Listen</span><span class="token punctuation">(</span><span class="token string">&quot;tcp&quot;</span><span class="token punctuation">,</span> address<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">&quot;cannot start server: %v\n&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
  <span class="token comment">// 启动 grpc 服务器。</span>
	err <span class="token operator">=</span> grpcServer<span class="token punctuation">.</span><span class="token function">Serve</span><span class="token punctuation">(</span>listener<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">&quot;cannot start server: %v\n&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>客户端启动函数：</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	serverAddress <span class="token operator">:=</span> flag<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token string">&quot;address&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;the server address&quot;</span><span class="token punctuation">)</span>
	flag<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;dial server %s\n&quot;</span><span class="token punctuation">,</span> <span class="token operator">*</span>serverAddress<span class="token punctuation">)</span>
  <span class="token comment">// 不使用 TLS 进行连接。</span>
	conn<span class="token punctuation">,</span> err <span class="token operator">:=</span> grpc<span class="token punctuation">.</span><span class="token function">Dial</span><span class="token punctuation">(</span><span class="token operator">*</span>serverAddress<span class="token punctuation">,</span> grpc<span class="token punctuation">.</span><span class="token function">WithInsecure</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">&quot;cannot dial server: %v\n&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
  <span class="token comment">// 调用生成的方法生成指定服务的客户端。</span>
	laptopClient <span class="token operator">:=</span> pb<span class="token punctuation">.</span><span class="token function">NewLaptopServiceClient</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span>
  <span class="token comment">// 创建一个 laptop 对象。</span>
	laptop <span class="token operator">:=</span> sample<span class="token punctuation">.</span><span class="token function">NewLaptop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">// 构建一个请求对象。</span>
	req <span class="token operator">:=</span> <span class="token operator">&amp;</span>pb<span class="token punctuation">.</span>CreateLaptopRequest<span class="token punctuation">{</span>
		Laptop<span class="token punctuation">:</span> laptop<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
  <span class="token comment">// 设置超时时间。</span>
	ctx<span class="token punctuation">,</span> cancelFunction <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithTimeout</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span>Second <span class="token operator">*</span> <span class="token number">5</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> <span class="token function">cancelFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">// 通过 client 调用方法</span>
	res<span class="token punctuation">,</span> err <span class="token operator">:=</span> laptopClient<span class="token punctuation">.</span><span class="token function">CreateLaptop</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> req<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span><span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">&quot;call createLaptop error: %v\n&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;created laptop with id: %s\n&quot;</span><span class="token punctuation">,</span> res<span class="token punctuation">.</span>Id<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><h2 id="服务端流式-rpc" tabindex="-1"><a class="header-anchor" href="#服务端流式-rpc" aria-hidden="true">#</a> 服务端流式 RPC</h2><p>生成的接口：</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">type</span> LaptopServiceServer <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">CreateLaptop</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> <span class="token operator">*</span>CreateLaptopRequest<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>CreateLaptopResponse<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
	<span class="token function">SearchLaptop</span><span class="token punctuation">(</span><span class="token operator">*</span>SearchLaptopRequest<span class="token punctuation">,</span> LaptopService_SearchLaptopServer<span class="token punctuation">)</span> <span class="token builtin">error</span>
	<span class="token function">mustEmbedUnimplementedLaptopServiceServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>实现这个接口：</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>server <span class="token operator">*</span>LaptopServer<span class="token punctuation">)</span> <span class="token function">SearchLaptop</span><span class="token punctuation">(</span>request <span class="token operator">*</span>pb<span class="token punctuation">.</span>SearchLaptopRequest<span class="token punctuation">,</span> stream pb<span class="token punctuation">.</span>LaptopService_SearchLaptopServer<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
  <span class="token comment">// 获取发送的 filter 对象。</span>
	filter <span class="token operator">:=</span> request<span class="token punctuation">.</span><span class="token function">GetFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;receive a search-laptop request with filter: %v&quot;</span><span class="token punctuation">,</span> filter<span class="token punctuation">)</span>
  <span class="token comment">// 向自定义方法传入参数，context 用来进行取消和超时处理，filter 用来筛选，传入函数用来以流形式回复客户端，这个自定义方法循环遍历 map 中的每个元素，每遇到一个符合 filter 要求的就调用这个传入的函数发回客户端</span>
	err <span class="token operator">:=</span> server<span class="token punctuation">.</span>LaptopStore<span class="token punctuation">.</span><span class="token function">Search</span><span class="token punctuation">(</span>stream<span class="token punctuation">.</span><span class="token function">Context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> filter<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>laptop <span class="token operator">*</span>pb<span class="token punctuation">.</span>Laptop<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
		res <span class="token operator">:=</span> <span class="token operator">&amp;</span>pb<span class="token punctuation">.</span>SearchLaptopResponse<span class="token punctuation">{</span>Laptop<span class="token punctuation">:</span> laptop<span class="token punctuation">}</span>
    <span class="token comment">// 流调用 Send 方法发送。</span>
		err <span class="token operator">:=</span> stream<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> err
		<span class="token punctuation">}</span>
		log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;sent laptop with id: %s&quot;</span><span class="token punctuation">,</span> laptop<span class="token punctuation">.</span><span class="token function">GetId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> status<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span>codes<span class="token punctuation">.</span>Internal<span class="token punctuation">,</span> <span class="token string">&quot;unexpected error: %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>客户端调用：</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">searchLaptop</span><span class="token punctuation">(</span>laptopClient pb<span class="token punctuation">.</span>LaptopServiceClient<span class="token punctuation">,</span> filter <span class="token operator">*</span>pb<span class="token punctuation">.</span>Filter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;search filter&quot;</span><span class="token punctuation">,</span> filter<span class="token punctuation">)</span>
	ctx<span class="token punctuation">,</span> cancel <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithTimeout</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token operator">*</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
	<span class="token keyword">defer</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	req <span class="token operator">:=</span> <span class="token operator">&amp;</span>pb<span class="token punctuation">.</span>SearchLaptopRequest<span class="token punctuation">{</span>
		Filter<span class="token punctuation">:</span> filter<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	stream<span class="token punctuation">,</span> err <span class="token operator">:=</span> laptopClient<span class="token punctuation">.</span><span class="token function">SearchLaptop</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> req<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">&quot;cannot search laptop: %v\n&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		res<span class="token punctuation">,</span> err <span class="token operator">:=</span> stream<span class="token punctuation">.</span><span class="token function">Recv</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">==</span> io<span class="token punctuation">.</span>EOF <span class="token punctuation">{</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">&quot;cannot receive response: %v\n&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		laptop <span class="token operator">:=</span> res<span class="token punctuation">.</span><span class="token function">GetLaptop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;- found laptop with id: %s&quot;</span><span class="token punctuation">,</span> laptop<span class="token punctuation">.</span>Id<span class="token punctuation">)</span>
		log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot; + found laptop with price_usd: %f&quot;</span><span class="token punctuation">,</span> laptop<span class="token punctuation">.</span>PriceUsd<span class="token punctuation">)</span>
		log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot; + found laptop with cpu_cores: %d&quot;</span><span class="token punctuation">,</span> laptop<span class="token punctuation">.</span>Cpu<span class="token punctuation">.</span>NumberCores<span class="token punctuation">)</span>
		log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot; + found laptop with ram: %d %v&quot;</span><span class="token punctuation">,</span> laptop<span class="token punctuation">.</span>Ram<span class="token punctuation">.</span>Value<span class="token punctuation">,</span> laptop<span class="token punctuation">.</span>Ram<span class="token punctuation">.</span>Unit<span class="token punctuation">)</span>
		log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot; + found laptop with min cpu_ghz: %f&quot;</span><span class="token punctuation">,</span> laptop<span class="token punctuation">.</span>Cpu<span class="token punctuation">.</span>MinGhz<span class="token punctuation">)</span>
		log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot; + found laptop with max cpu_ghz: %f&quot;</span><span class="token punctuation">,</span> laptop<span class="token punctuation">.</span>Cpu<span class="token punctuation">.</span>MaxGhz<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p>服务端、客户端启动函数不需要变化。</p><h2 id="客户端流式-rpc" tabindex="-1"><a class="header-anchor" href="#客户端流式-rpc" aria-hidden="true">#</a> 客户端流式 RPC</h2><p>生成的接口：</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">type</span> LaptopServiceServer <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">CreateLaptop</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> <span class="token operator">*</span>CreateLaptopRequest<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>CreateLaptopResponse<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
	<span class="token function">SearchLaptop</span><span class="token punctuation">(</span><span class="token operator">*</span>SearchLaptopRequest<span class="token punctuation">,</span> LaptopService_SearchLaptopServer<span class="token punctuation">)</span> <span class="token builtin">error</span>
	<span class="token function">UploadImage</span><span class="token punctuation">(</span>LaptopService_UploadImageServer<span class="token punctuation">)</span> <span class="token builtin">error</span>
	<span class="token function">mustEmbedUnimplementedLaptopServiceServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>实现这个接口：</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>server <span class="token operator">*</span>LaptopServer<span class="token punctuation">)</span> <span class="token function">UploadImage</span><span class="token punctuation">(</span>stream pb<span class="token punctuation">.</span>LaptopService_UploadImageServer<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
  <span class="token comment">// 调用 Recv() 方法获取客户端发来的请求，此请求包含 oneof</span>
	req<span class="token punctuation">,</span> err <span class="token operator">:=</span> stream<span class="token punctuation">.</span><span class="token function">Recv</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token function">logErr</span><span class="token punctuation">(</span>status<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span>codes<span class="token punctuation">.</span>Unknown<span class="token punctuation">,</span> <span class="token string">&quot;cannot receive image info&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
  <span class="token comment">// 接收第一轮请求，这一轮请求包含 laptop 的 ID 和图片的类型，后续请求只有二进制数组。</span>
	laptopID <span class="token operator">:=</span> req<span class="token punctuation">.</span><span class="token function">GetInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetLaptopId</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	imageType <span class="token operator">:=</span> req<span class="token punctuation">.</span><span class="token function">GetInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetImageType</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;receive an upload-image request for laptop %s with image type %s&quot;</span><span class="token punctuation">,</span> laptopID<span class="token punctuation">,</span> imageType<span class="token punctuation">)</span>
	laptop<span class="token punctuation">,</span> err <span class="token operator">:=</span> server<span class="token punctuation">.</span>LaptopStore<span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span>laptopID<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token function">logErr</span><span class="token punctuation">(</span>status<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span>codes<span class="token punctuation">.</span>Internal<span class="token punctuation">,</span> <span class="token string">&quot;cannot find laptop: %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> laptop <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token function">logErr</span><span class="token punctuation">(</span>status<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span>codes<span class="token punctuation">.</span>NotFound<span class="token punctuation">,</span> <span class="token string">&quot;laptop with ID: %s dosen&#39;t exist&quot;</span><span class="token punctuation">,</span> laptopID<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
  <span class="token comment">// 创建缓冲区。</span>
	imageData <span class="token operator">:=</span> bytes<span class="token punctuation">.</span>Buffer<span class="token punctuation">{</span><span class="token punctuation">}</span>
	imageSize <span class="token operator">:=</span> <span class="token number">0</span>
  <span class="token comment">// 流式请求要循环接收。</span>
	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;waiting to receive more data&quot;</span><span class="token punctuation">)</span>
		req<span class="token punctuation">,</span> err <span class="token operator">:=</span> stream<span class="token punctuation">.</span><span class="token function">Recv</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 如果到达流的末尾。</span>
		<span class="token keyword">if</span> err <span class="token operator">==</span> io<span class="token punctuation">.</span>EOF <span class="token punctuation">{</span>
			log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;no more data&quot;</span><span class="token punctuation">)</span>
			<span class="token keyword">break</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token function">logErr</span><span class="token punctuation">(</span>status<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span>codes<span class="token punctuation">.</span>Unknown<span class="token punctuation">,</span> <span class="token string">&quot;cannot receive chunk data: %v\n&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>

		chunk <span class="token operator">:=</span> req<span class="token punctuation">.</span><span class="token function">GetChunkData</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		size <span class="token operator">:=</span> <span class="token function">len</span><span class="token punctuation">(</span>chunk<span class="token punctuation">)</span>
		log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;receive data with size:&quot;</span><span class="token punctuation">,</span> size<span class="token punctuation">)</span>
		imageSize <span class="token operator">+=</span> size
    <span class="token comment">// 限制大小。</span>
		<span class="token keyword">if</span> imageSize <span class="token operator">&gt;</span> maxImageSize <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token function">logErr</span><span class="token punctuation">(</span>status<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span>codes<span class="token punctuation">.</span>InvalidArgument<span class="token punctuation">,</span> <span class="token string">&quot;image is too large: %d &gt; %d\n&quot;</span><span class="token punctuation">,</span> imageSize<span class="token punctuation">,</span> maxImageSize<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
    <span class="token comment">// 写入缓冲区。</span>
		<span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">=</span> imageData<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>chunk<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token function">logErr</span><span class="token punctuation">(</span>status<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span>codes<span class="token punctuation">.</span>Internal<span class="token punctuation">,</span> <span class="token string">&quot;cannot write chunk data: %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	imageID<span class="token punctuation">,</span> err <span class="token operator">:=</span> server<span class="token punctuation">.</span>ImageStore<span class="token punctuation">.</span><span class="token function">Save</span><span class="token punctuation">(</span>laptopID<span class="token punctuation">,</span> imageType<span class="token punctuation">,</span> imageData<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token function">logErr</span><span class="token punctuation">(</span>status<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span>codes<span class="token punctuation">.</span>Internal<span class="token punctuation">,</span> <span class="token string">&quot;cannot save image to the store: %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	res <span class="token operator">:=</span> <span class="token operator">&amp;</span>pb<span class="token punctuation">.</span>UploadImageResponse<span class="token punctuation">{</span>
		Id<span class="token punctuation">:</span>   imageID<span class="token punctuation">,</span>
		Size<span class="token punctuation">:</span> <span class="token function">uint32</span><span class="token punctuation">(</span>imageSize<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
  <span class="token comment">// 发送并关闭流，将相应发送回客户端。</span>
	err <span class="token operator">=</span> stream<span class="token punctuation">.</span><span class="token function">SendAndClose</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token function">logErr</span><span class="token punctuation">(</span>status<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span>codes<span class="token punctuation">.</span>Unknown<span class="token punctuation">,</span> <span class="token string">&quot;cannot send response: %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;save image with id: %s, size: %d successfully\n&quot;</span><span class="token punctuation">,</span> imageID<span class="token punctuation">,</span> imageSize<span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br></div></div><p>客户端调用：</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">uploadImage</span><span class="token punctuation">(</span>laptopClient pb<span class="token punctuation">.</span>LaptopServiceClient<span class="token punctuation">,</span> laptopID<span class="token punctuation">,</span> imagePath <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	file<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>imagePath<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span><span class="token string">&quot;cannot open image file:&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">defer</span> file<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	ctx<span class="token punctuation">,</span> cancel <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithTimeout</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span>Second<span class="token operator">*</span><span class="token number">5</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	stream<span class="token punctuation">,</span> err <span class="token operator">:=</span> laptopClient<span class="token punctuation">.</span><span class="token function">UploadImage</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span><span class="token string">&quot;cannot upload image: &quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	req <span class="token operator">:=</span> <span class="token operator">&amp;</span>pb<span class="token punctuation">.</span>UploadImageRequest<span class="token punctuation">{</span>
		Data<span class="token punctuation">:</span> <span class="token operator">&amp;</span>pb<span class="token punctuation">.</span>UploadImageRequest_Info<span class="token punctuation">{</span>
			Info<span class="token punctuation">:</span> <span class="token operator">&amp;</span>pb<span class="token punctuation">.</span>ImageInfo<span class="token punctuation">{</span>
				LaptopId<span class="token punctuation">:</span>  laptopID<span class="token punctuation">,</span>
				ImageType<span class="token punctuation">:</span> filepath<span class="token punctuation">.</span><span class="token function">Ext</span><span class="token punctuation">(</span>imagePath<span class="token punctuation">)</span><span class="token punctuation">,</span>
			<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	err <span class="token operator">=</span> stream<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span><span class="token string">&quot;cannot send image info:&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	reader <span class="token operator">:=</span> bufio<span class="token punctuation">.</span><span class="token function">NewReader</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span>
	buffer <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		n<span class="token punctuation">,</span> err <span class="token operator">:=</span> reader<span class="token punctuation">.</span><span class="token function">Read</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">==</span> io<span class="token punctuation">.</span>EOF <span class="token punctuation">{</span>
			<span class="token keyword">break</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span><span class="token string">&quot;cannot read chunk to buffer:&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		req <span class="token operator">:=</span> <span class="token operator">&amp;</span>pb<span class="token punctuation">.</span>UploadImageRequest<span class="token punctuation">{</span>
			Data<span class="token punctuation">:</span> <span class="token operator">&amp;</span>pb<span class="token punctuation">.</span>UploadImageRequest_ChunkData<span class="token punctuation">{</span>
				ChunkData<span class="token punctuation">:</span> buffer<span class="token punctuation">[</span><span class="token punctuation">:</span>n<span class="token punctuation">]</span><span class="token punctuation">,</span>
			<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span>

		err <span class="token operator">=</span> stream<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token comment">// 获取实际错误</span>
			err2 <span class="token operator">:=</span> stream<span class="token punctuation">.</span><span class="token function">RecvMsg</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">)</span>
			log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span><span class="token string">&quot;cannot send chunk to server:&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">,</span> err2<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	res<span class="token punctuation">,</span> err <span class="token operator">:=</span> stream<span class="token punctuation">.</span><span class="token function">CloseAndRecv</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span><span class="token string">&quot;cannot receive response:&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;upload image with ID: %s and size: %d&quot;</span><span class="token punctuation">,</span> res<span class="token punctuation">.</span>Id<span class="token punctuation">,</span> res<span class="token punctuation">.</span>Size<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br></div></div><p>服务端、客户端启动函数无变化。</p><h2 id="双向流式-rpc" tabindex="-1"><a class="header-anchor" href="#双向流式-rpc" aria-hidden="true">#</a> 双向流式 RPC</h2><p>生成的接口：</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">type</span> LaptopServiceServer <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">CreateLaptop</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> <span class="token operator">*</span>CreateLaptopRequest<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>CreateLaptopResponse<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
	<span class="token function">SearchLaptop</span><span class="token punctuation">(</span><span class="token operator">*</span>SearchLaptopRequest<span class="token punctuation">,</span> LaptopService_SearchLaptopServer<span class="token punctuation">)</span> <span class="token builtin">error</span>
	<span class="token function">UploadImage</span><span class="token punctuation">(</span>LaptopService_UploadImageServer<span class="token punctuation">)</span> <span class="token builtin">error</span>
	<span class="token function">RateLaptop</span><span class="token punctuation">(</span>LaptopService_RateLaptopServer<span class="token punctuation">)</span> <span class="token builtin">error</span>
	<span class="token function">mustEmbedUnimplementedLaptopServiceServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>实现这个接口：</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>server <span class="token operator">*</span>LaptopServer<span class="token punctuation">)</span> <span class="token function">RateLaptop</span><span class="token punctuation">(</span>stream pb<span class="token punctuation">.</span>LaptopService_RateLaptopServer<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> <span class="token punctuation">{</span>
    <span class="token comment">// 获取 context 错误并进行超时和取消判断。</span>
		err <span class="token operator">:=</span> stream<span class="token punctuation">.</span><span class="token function">Context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">==</span> context<span class="token punctuation">.</span>Canceled <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token function">logErr</span><span class="token punctuation">(</span>status<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>codes<span class="token punctuation">.</span>Canceled<span class="token punctuation">,</span> <span class="token string">&quot;request canceled&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> err <span class="token operator">==</span> context<span class="token punctuation">.</span>DeadlineExceeded <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token function">logErr</span><span class="token punctuation">(</span>status<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>codes<span class="token punctuation">.</span>DeadlineExceeded<span class="token punctuation">,</span> <span class="token string">&quot;deadline exceeded&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token function">logErr</span><span class="token punctuation">(</span>status<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span>codes<span class="token punctuation">.</span>Unknown<span class="token punctuation">,</span> <span class="token string">&quot;unknown error: %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
    <span class="token comment">// 接收客户端发来的请求。</span>
		req<span class="token punctuation">,</span> err <span class="token operator">:=</span> stream<span class="token punctuation">.</span><span class="token function">Recv</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 如果到达流的末尾就退出循环。</span>
		<span class="token keyword">if</span> err <span class="token operator">==</span> io<span class="token punctuation">.</span>EOF <span class="token punctuation">{</span>
			log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;no more data&quot;</span><span class="token punctuation">)</span>
			<span class="token keyword">break</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token function">logErr</span><span class="token punctuation">(</span>status<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span>codes<span class="token punctuation">.</span>Unknown<span class="token punctuation">,</span> <span class="token string">&quot;cannot receive stream request: %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		laptopID <span class="token operator">:=</span> req<span class="token punctuation">.</span><span class="token function">GetLaptopId</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		score <span class="token operator">:=</span> req<span class="token punctuation">.</span><span class="token function">GetScore</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;receive a rate-laptop request with laptopID: %s and score: %f\n&quot;</span><span class="token punctuation">,</span> laptopID<span class="token punctuation">,</span> score<span class="token punctuation">)</span>
		laptop<span class="token punctuation">,</span> err <span class="token operator">:=</span> server<span class="token punctuation">.</span>LaptopStore<span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span>laptopID<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token function">logErr</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> laptop <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token function">logErr</span><span class="token punctuation">(</span>status<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span>codes<span class="token punctuation">.</span>NotFound<span class="token punctuation">,</span> <span class="token string">&quot;cannot find laptop with ID: %s&quot;</span><span class="token punctuation">,</span> laptopID<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		rating<span class="token punctuation">,</span> err <span class="token operator">:=</span> server<span class="token punctuation">.</span>RatingStore<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>laptopID<span class="token punctuation">,</span> score<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token function">logErr</span><span class="token punctuation">(</span>status<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span>codes<span class="token punctuation">.</span>Internal<span class="token punctuation">,</span> <span class="token string">&quot;cannot add rating: %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		res <span class="token operator">:=</span> <span class="token operator">&amp;</span>pb<span class="token punctuation">.</span>RateLaptopResponse<span class="token punctuation">{</span>
			LaptopId<span class="token punctuation">:</span>     laptopID<span class="token punctuation">,</span>
			RatedCount<span class="token punctuation">:</span>   rating<span class="token punctuation">.</span>Count<span class="token punctuation">,</span>
			AverageScore<span class="token punctuation">:</span> rating<span class="token punctuation">.</span>Sum <span class="token operator">/</span> <span class="token function">float64</span><span class="token punctuation">(</span>rating<span class="token punctuation">.</span>Count<span class="token punctuation">)</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span>
    <span class="token comment">// 每轮请求都有返回值所以直接 Send</span>
		err <span class="token operator">=</span> stream<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token function">logErr</span><span class="token punctuation">(</span>status<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span>codes<span class="token punctuation">.</span>Unknown<span class="token punctuation">,</span> <span class="token string">&quot;cannot send response: %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br></div></div><p>客户端调用：</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">rateLaptop</span><span class="token punctuation">(</span>laptopID <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">,</span> score <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">float64</span><span class="token punctuation">,</span> laptopClient pb<span class="token punctuation">.</span>LaptopServiceClient<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>laptopID<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token function">len</span><span class="token punctuation">(</span>score<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;laptopID&#39;s num dosen&#39;t eqal to the score&#39;s num&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	ctx<span class="token punctuation">,</span> cancel <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithTimeout</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span>Second<span class="token operator">*</span><span class="token number">5</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	stream<span class="token punctuation">,</span> err <span class="token operator">:=</span> laptopClient<span class="token punctuation">.</span><span class="token function">RateLaptop</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">&quot;cannot rate laptop: %v\n&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	waitResponse <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">for</span> <span class="token punctuation">{</span>
			res<span class="token punctuation">,</span> err <span class="token operator">:=</span> stream<span class="token punctuation">.</span><span class="token function">Recv</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token keyword">if</span> err <span class="token operator">==</span> io<span class="token punctuation">.</span>EOF <span class="token punctuation">{</span>
				log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;no more response&quot;</span><span class="token punctuation">)</span>
				waitResponse <span class="token operator">&lt;-</span> <span class="token boolean">nil</span>
				<span class="token keyword">return</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
				waitResponse <span class="token operator">&lt;-</span> err
				<span class="token keyword">return</span>
			<span class="token punctuation">}</span>
			log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;receive response: %v\n&quot;</span><span class="token punctuation">,</span> res<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> i<span class="token punctuation">,</span> laptopID <span class="token operator">:=</span> <span class="token keyword">range</span> laptopID <span class="token punctuation">{</span>
		req <span class="token operator">:=</span> <span class="token operator">&amp;</span>pb<span class="token punctuation">.</span>RateLaptopRequest<span class="token punctuation">{</span>
			LaptopId<span class="token punctuation">:</span> laptopID<span class="token punctuation">,</span>
			Score<span class="token punctuation">:</span>    score<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span>
		err <span class="token operator">:=</span> stream<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;cannot send stream request: %v - %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">,</span> stream<span class="token punctuation">.</span><span class="token function">RecvMsg</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;send request: %v\n&quot;</span><span class="token punctuation">,</span> req<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	err <span class="token operator">=</span> stream<span class="token punctuation">.</span><span class="token function">CloseSend</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;cannot close send: %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	err <span class="token operator">=</span> <span class="token operator">&lt;-</span>waitResponse
	<span class="token keyword">return</span> err
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br></div></div><p>客户端、服务端启动函数没有变化。</p><h2 id="metadata、interceptor、jwt" tabindex="-1"><a class="header-anchor" href="#metadata、interceptor、jwt" aria-hidden="true">#</a> metadata、interceptor、JWT</h2><p>设计思想：设计一个登录接口，登录成功后返回 token，客户端使用拦截器在出站请求的 metadata 中添加 token，服务端通过拦截器判断是否需要拦截或者需要的角色，并对 token 进行合法校验和权限判断。</p><p>生成的接口：</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">type</span> AuthServiceServer <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">Login</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> <span class="token operator">*</span>LoginRequest<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>LoginResponse<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
  <span class="token comment">// 同样需要嵌套。</span>
	<span class="token function">mustEmbedUnimplementedAuthServiceServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>实现这个接口：</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">type</span> AuthServer <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	userStore  UserStore
	jwtManager JWTManager
	pb<span class="token punctuation">.</span>UnimplementedAuthServiceServer
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>authServer <span class="token operator">*</span>AuthServer<span class="token punctuation">)</span> <span class="token function">Login</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> req <span class="token operator">*</span>pb<span class="token punctuation">.</span>LoginRequest<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>pb<span class="token punctuation">.</span>LoginResponse<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	user<span class="token punctuation">,</span> err <span class="token operator">:=</span> authServer<span class="token punctuation">.</span>userStore<span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>Username<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
	<span class="token punctuation">}</span>
  <span class="token comment">// 此处是将传来的密码进行 hash，与正确密码的 hash 比较得出。</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>user<span class="token punctuation">.</span><span class="token function">IsCorrectPassword</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>Password<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> status<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span>codes<span class="token punctuation">.</span>NotFound<span class="token punctuation">,</span> <span class="token string">&quot;incorrect password&quot;</span><span class="token punctuation">,</span> req<span class="token punctuation">.</span>Username<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
  <span class="token comment">// 如果信息正确就返回。</span>
	token<span class="token punctuation">,</span> err <span class="token operator">:=</span> authServer<span class="token punctuation">.</span>jwtManager<span class="token punctuation">.</span><span class="token function">GenerateToken</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> status<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span>codes<span class="token punctuation">.</span>Internal<span class="token punctuation">,</span> <span class="token string">&quot;cannot generate token&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>pb<span class="token punctuation">.</span>LoginResponse<span class="token punctuation">{</span>
		AccessToken<span class="token punctuation">:</span> token<span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>grpc/server.go 中定义了两个方法如下：</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">UnaryInterceptor</span><span class="token punctuation">(</span>i UnaryServerInterceptor<span class="token punctuation">)</span> ServerOption
<span class="token keyword">func</span> <span class="token function">StreamInterceptor</span><span class="token punctuation">(</span>i StreamServerInterceptor<span class="token punctuation">)</span> ServerOption
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>这两个方法的返回值为 ServerOption 类型，将这个类型对象传入 gRPC server 构造方法中可以实现添加拦截器，这两个函数的参数定义在 grpc/interceptor.go 中：</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">type</span> UnaryServerInterceptor <span class="token keyword">func</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> req <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> info <span class="token operator">*</span>UnaryServerInfo<span class="token punctuation">,</span> handler UnaryHandler<span class="token punctuation">)</span> <span class="token punctuation">(</span>resp <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span>
<span class="token keyword">type</span> StreamServerInterceptor <span class="token keyword">func</span><span class="token punctuation">(</span>srv <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> ss ServerStream<span class="token punctuation">,</span> info <span class="token operator">*</span>StreamServerInfo<span class="token punctuation">,</span> handler StreamHandler<span class="token punctuation">)</span> <span class="token builtin">error</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>因此，自定义拦截器只要分别定义两个方法，分别返回这两种类型的返回值，再将这个返回值传入 gRPC server 构造函数中即可。</p><p>实现：</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">type</span> AuthInterceptor <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	jwtManager      <span class="token operator">*</span>JWTManager
	accessibleRoles <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span> <span class="token comment">// 键为方法名，值为允许访问的角色列表。</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>interceptor <span class="token operator">*</span>AuthInterceptor<span class="token punctuation">)</span> <span class="token function">Unary</span><span class="token punctuation">(</span><span class="token punctuation">)</span> grpc<span class="token punctuation">.</span>UnaryServerInterceptor <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> req <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> info <span class="token operator">*</span>grpc<span class="token punctuation">.</span>UnaryServerInfo<span class="token punctuation">,</span> handler grpc<span class="token punctuation">.</span>UnaryHandler<span class="token punctuation">)</span> <span class="token punctuation">(</span>resp <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;--&gt; unary interceptor:&quot;</span><span class="token punctuation">,</span> info<span class="token punctuation">.</span>FullMethod<span class="token punctuation">)</span>
		err <span class="token operator">=</span> interceptor<span class="token punctuation">.</span><span class="token function">authorize</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> info<span class="token punctuation">.</span>FullMethod<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> <span class="token function">handler</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> req<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>interceptor <span class="token operator">*</span>AuthInterceptor<span class="token punctuation">)</span> <span class="token function">Stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span> grpc<span class="token punctuation">.</span>StreamServerInterceptor <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>srv <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> ss grpc<span class="token punctuation">.</span>ServerStream<span class="token punctuation">,</span> info <span class="token operator">*</span>grpc<span class="token punctuation">.</span>StreamServerInfo<span class="token punctuation">,</span> handler grpc<span class="token punctuation">.</span>StreamHandler<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;--&gt; stream interceptor:&quot;</span><span class="token punctuation">,</span> info<span class="token punctuation">.</span>FullMethod<span class="token punctuation">)</span>
		err <span class="token operator">:=</span> interceptor<span class="token punctuation">.</span><span class="token function">authorize</span><span class="token punctuation">(</span>ss<span class="token punctuation">.</span><span class="token function">Context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> info<span class="token punctuation">.</span>FullMethod<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> err
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> <span class="token function">handler</span><span class="token punctuation">(</span>srv<span class="token punctuation">,</span> ss<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>interceptor <span class="token operator">*</span>AuthInterceptor<span class="token punctuation">)</span> <span class="token function">authorize</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> fullMethod <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	accessibleRoles <span class="token operator">:=</span> interceptor<span class="token punctuation">.</span>accessibleRoles<span class="token punctuation">[</span>fullMethod<span class="token punctuation">]</span>
  <span class="token comment">// 如果没有可以访问的角色列表，那么就是不设限制。</span>
	<span class="token keyword">if</span> accessibleRoles <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span>
	<span class="token punctuation">}</span>
  <span class="token comment">// 从 context 中获取 metadata map[string][]string</span>
	md<span class="token punctuation">,</span> ok <span class="token operator">:=</span> metadata<span class="token punctuation">.</span><span class="token function">FromIncomingContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
		<span class="token keyword">return</span> status<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span>codes<span class="token punctuation">.</span>DataLoss<span class="token punctuation">,</span> <span class="token string">&quot;need metadata&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
  <span class="token comment">// 用约定好的键取出值。</span>
	values <span class="token operator">:=</span> md<span class="token punctuation">[</span><span class="token string">&quot;authorization&quot;</span><span class="token punctuation">]</span>
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>values<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> status<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span>codes<span class="token punctuation">.</span>DataLoss<span class="token punctuation">,</span> <span class="token string">&quot;need authorization token&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
  <span class="token comment">// 约定数组只有一个元素就是 token。</span>
	accessToken <span class="token operator">:=</span> values<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
  <span class="token comment">// 验证 token。</span>
	claims<span class="token punctuation">,</span> err <span class="token operator">:=</span> interceptor<span class="token punctuation">.</span>jwtManager<span class="token punctuation">.</span><span class="token function">Verify</span><span class="token punctuation">(</span>accessToken<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> status<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span>codes<span class="token punctuation">.</span>InvalidArgument<span class="token punctuation">,</span> <span class="token string">&quot;access token is invalid: %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token function">contains</span><span class="token punctuation">(</span>accessibleRoles<span class="token punctuation">,</span> claims<span class="token punctuation">.</span>Role<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> status<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span>codes<span class="token punctuation">.</span>PermissionDenied<span class="token punctuation">,</span> <span class="token string">&quot;no permission to call %s&quot;</span><span class="token punctuation">,</span> fullMethod<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br></div></div><p>服务端启动函数：</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code>grpcServer <span class="token operator">:=</span> grpc<span class="token punctuation">.</span><span class="token function">NewServer</span><span class="token punctuation">(</span>
  grpc<span class="token punctuation">.</span><span class="token function">UnaryInterceptor</span><span class="token punctuation">(</span>authInterceptor<span class="token punctuation">.</span><span class="token function">Unary</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  grpc<span class="token punctuation">.</span><span class="token function">StreamInterceptor</span><span class="token punctuation">(</span>authInterceptor<span class="token punctuation">.</span><span class="token function">Stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>定义客户端拦截器：</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">type</span> AuthInterceptor <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	authClient  <span class="token operator">*</span>AuthClient <span class="token comment">// 另一个自定义结构体，用来通过用户名密码获取 access token。</span>
	authMethods <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">bool</span> <span class="token comment">// 键为方法名，值为布尔，表示是否需要 token。</span>
	accessToken <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token comment">// 这里两个函数的返回值也是函数，函数签名与服务端拦截器在同一个文件：grpc/interceptor.go 中。</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>authInterceptor <span class="token operator">*</span>AuthInterceptor<span class="token punctuation">)</span> <span class="token function">Unary</span><span class="token punctuation">(</span><span class="token punctuation">)</span> grpc<span class="token punctuation">.</span>UnaryClientInterceptor <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> method <span class="token builtin">string</span><span class="token punctuation">,</span> req<span class="token punctuation">,</span> reply <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> cc <span class="token operator">*</span>grpc<span class="token punctuation">.</span>ClientConn<span class="token punctuation">,</span> invoker grpc<span class="token punctuation">.</span>UnaryInvoker<span class="token punctuation">,</span> opts <span class="token operator">...</span>grpc<span class="token punctuation">.</span>CallOption<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;--&gt; unary interceptor: %s&quot;</span><span class="token punctuation">,</span> method<span class="token punctuation">)</span>
    <span class="token comment">// 如果需要认证。</span>
		<span class="token keyword">if</span> authInterceptor<span class="token punctuation">.</span>authMethods<span class="token punctuation">[</span>method<span class="token punctuation">]</span> <span class="token punctuation">{</span>
      <span class="token comment">// 为 context 添加 token，然后将请求返回</span>
			<span class="token keyword">return</span> <span class="token function">invoker</span><span class="token punctuation">(</span>authInterceptor<span class="token punctuation">.</span><span class="token function">attachToken</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">,</span> method<span class="token punctuation">,</span> req<span class="token punctuation">,</span> reply<span class="token punctuation">,</span> cc<span class="token punctuation">,</span> opts<span class="token operator">...</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> <span class="token function">invoker</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> method<span class="token punctuation">,</span> req<span class="token punctuation">,</span> reply<span class="token punctuation">,</span> cc<span class="token punctuation">,</span> opts<span class="token operator">...</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>authInterceptor <span class="token operator">*</span>AuthInterceptor<span class="token punctuation">)</span> <span class="token function">Stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span> grpc<span class="token punctuation">.</span>StreamClientInterceptor <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> desc <span class="token operator">*</span>grpc<span class="token punctuation">.</span>StreamDesc<span class="token punctuation">,</span> cc <span class="token operator">*</span>grpc<span class="token punctuation">.</span>ClientConn<span class="token punctuation">,</span> method <span class="token builtin">string</span><span class="token punctuation">,</span> streamer grpc<span class="token punctuation">.</span>Streamer<span class="token punctuation">,</span> opts <span class="token operator">...</span>grpc<span class="token punctuation">.</span>CallOption<span class="token punctuation">)</span> <span class="token punctuation">(</span>grpc<span class="token punctuation">.</span>ClientStream<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;--&gt; stream interceptor: %s&quot;</span><span class="token punctuation">,</span> method<span class="token punctuation">)</span>
		<span class="token keyword">if</span> authInterceptor<span class="token punctuation">.</span>authMethods<span class="token punctuation">[</span>method<span class="token punctuation">]</span> <span class="token punctuation">{</span>
      <span class="token comment">// 为 context 添加 token，然后将请求返回</span>
			<span class="token keyword">return</span> <span class="token function">streamer</span><span class="token punctuation">(</span>authInterceptor<span class="token punctuation">.</span><span class="token function">attachToken</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">,</span> desc<span class="token punctuation">,</span> cc<span class="token punctuation">,</span> method<span class="token punctuation">,</span> opts<span class="token operator">...</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> <span class="token function">streamer</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> desc<span class="token punctuation">,</span> cc<span class="token punctuation">,</span> method<span class="token punctuation">,</span> opts<span class="token operator">...</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>authInterceptor <span class="token operator">*</span>AuthInterceptor<span class="token punctuation">)</span> <span class="token function">attachToken</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> context<span class="token punctuation">.</span>Context <span class="token punctuation">{</span>
  <span class="token comment">// 这里的键要和服务端取出的键一致。</span>
	<span class="token keyword">return</span> metadata<span class="token punctuation">.</span><span class="token function">AppendToOutgoingContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">&quot;authorization&quot;</span><span class="token punctuation">,</span> authInterceptor<span class="token punctuation">.</span>accessToken<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><p>由于 token 存在有效期，所以在客户端拦截器上定义一个定时刷新 token 的方法：</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>authInterceptor <span class="token operator">*</span>AuthInterceptor<span class="token punctuation">)</span> <span class="token function">refreshToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	accessToken<span class="token punctuation">,</span> err <span class="token operator">:=</span> authInterceptor<span class="token punctuation">.</span>authClient<span class="token punctuation">.</span><span class="token function">Login</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>
	authInterceptor<span class="token punctuation">.</span>accessToken <span class="token operator">=</span> accessToken
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>authInterceptor <span class="token operator">*</span>AuthInterceptor<span class="token punctuation">)</span> <span class="token function">scheduleRefreshToken</span><span class="token punctuation">(</span>refreshDuration time<span class="token punctuation">.</span>Duration<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
  <span class="token comment">// 第一次执行先尝试获取 token，如果失败则直接结束。</span>
	err <span class="token operator">:=</span> authInterceptor<span class="token punctuation">.</span><span class="token function">refreshToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>
	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		wait <span class="token operator">:=</span> refreshDuration
		<span class="token keyword">for</span> <span class="token punctuation">{</span>
			time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>wait<span class="token punctuation">)</span>
			err <span class="token operator">:=</span> authInterceptor<span class="token punctuation">.</span><span class="token function">refreshToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果失败了就短时间内重新尝试。</span>
				wait <span class="token operator">=</span> time<span class="token punctuation">.</span>Second
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
				wait <span class="token operator">=</span> refreshDuration
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p>客户端启动函数：</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// 因为客户端拦截器成员中有一个 access token，所以客户端先使用不带拦截器的 grpc 连接到服务端并进行登录获取 token，获取 token 后创建出拦截器再新建带有拦截器的 grpc 连接。</span>
conn<span class="token punctuation">,</span> err <span class="token operator">:=</span> grpc<span class="token punctuation">.</span><span class="token function">Dial</span><span class="token punctuation">(</span><span class="token operator">*</span>serverAddress<span class="token punctuation">,</span> grpc<span class="token punctuation">.</span><span class="token function">WithUnaryInterceptor</span><span class="token punctuation">(</span>interceptor<span class="token punctuation">.</span><span class="token function">Unary</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> grpc<span class="token punctuation">.</span><span class="token function">WithStreamInterceptor</span><span class="token punctuation">(</span>interceptor<span class="token punctuation">.</span><span class="token function">Stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h2 id="ssl-tls" tabindex="-1"><a class="header-anchor" href="#ssl-tls" aria-hidden="true">#</a> SSL TLS</h2><p>流程：服务端具有一个公钥和一个私钥，首先服务端创建证书签名 CSR，其中包含服务端的公钥和一些身份信息，然后服务端使用私钥签署了 CSR 并发送给 CA，CA 使用服务端的公钥验证 CSR 签名，这样就验证了一对对应的私钥和公钥，之后（此时证书应该不是被服务单私钥加密的状态） CA 使用自己的私钥在证书上签名然后返回给服务端，服务端与客户端共享这个证书，客户端可以使用 CA 的公钥对证书进行验证并获取到服务端的公钥。</p><p>首先使用 OpenSSL 生成 CA 密钥和证书、服务端密钥和证书、客户端密钥和证书：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># 1. Generate CA&#39;s private key and self-signed certificate</span>
openssl req -x509 -newkey rsa:4096 -days <span class="token number">365</span> -nodes -keyout ca-key.pem -out ca-cert.pem -subj <span class="token string">&quot;/C=CN/ST=ShanDong/L=QingDao/O=company/OU=demo/CN=koston/emailAddress=koston.zhuang@demo.com&quot;</span>

<span class="token comment"># 2. Generate web server&#39;s private key and certificate signing request (CSR)</span>
openssl req -newkey rsa:4096 -nodes -keyout server-key.pem -out server-req.pem -subj <span class="token string">&quot;/C=CN/ST=ShanDong/L=QingDao/O=company/OU=demo/CN=koston/emailAddress=koston.zhuang@demo.com&quot;</span>

<span class="token comment"># 3. Use CA&#39;s private key to sign web server&#39;s CSR and get back the signed certificate</span>
openssl x509 -req -in server-req.pem -days <span class="token number">60</span> -CA ca-cert.pem -CAkey ca-key.pem -CAcreateserial -out server-cert.pem -extfile server-ext.cnf

<span class="token comment"># 4. Generate client&#39;s private key and certificate signing request (CSR)</span>
openssl req -newkey rsa:4096 -nodes -keyout client-key.pem -out client-req.pem -subj <span class="token string">&quot;/C=CN/ST=ShanDong/L=QingDao/O=company/OU=demo/CN=koston/emailAddress=koston.zhuang@demo.com&quot;</span>

<span class="token comment"># 5. Use CA&#39;s private key to sign client&#39;s CSR and get back the signed certificate</span>
openssl x509 -req -in client-req.pem -days <span class="token number">60</span> -CA ca-cert.pem -CAkey ca-key.pem -CAcreateserial -out client-cert.pem -extfile client-ext.cnf
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h3 id="服务端认证" tabindex="-1"><a class="header-anchor" href="#服务端认证" aria-hidden="true">#</a> 服务端认证</h3><p>修改服务端启动函数：</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">loadTLSCredentials</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>credentials<span class="token punctuation">.</span>TransportCredentials<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	serverCert<span class="token punctuation">,</span> err <span class="token operator">:=</span> tls<span class="token punctuation">.</span><span class="token function">LoadX509KeyPair</span><span class="token punctuation">(</span><span class="token string">&quot;ssl/server-cert.pem&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;ssl/server-key.pem&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
	<span class="token punctuation">}</span>
	config <span class="token operator">:=</span> <span class="token operator">&amp;</span>tls<span class="token punctuation">.</span>Config<span class="token punctuation">{</span>
		Certificates<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>tls<span class="token punctuation">.</span>Certificate<span class="token punctuation">{</span>serverCert<span class="token punctuation">}</span><span class="token punctuation">,</span>
		ClientAuth<span class="token punctuation">:</span> tls<span class="token punctuation">.</span>NoClientCert<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> credentials<span class="token punctuation">.</span><span class="token function">NewTLS</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
<span class="token comment">// main 函数中</span>
tlsCredentials<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">loadTLSCredentials</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
	log<span class="token punctuation">.</span><span class="token function">Fatalln</span><span class="token punctuation">(</span><span class="token string">&quot;cannot load TLS credentials:&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
grpcServer <span class="token operator">:=</span> grpc<span class="token punctuation">.</span><span class="token function">NewServer</span><span class="token punctuation">(</span>
	grpc<span class="token punctuation">.</span><span class="token function">Creds</span><span class="token punctuation">(</span>tlsCredentials<span class="token punctuation">)</span><span class="token punctuation">,</span>
	grpc<span class="token punctuation">.</span><span class="token function">UnaryInterceptor</span><span class="token punctuation">(</span>authInterceptor<span class="token punctuation">.</span><span class="token function">Unary</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	grpc<span class="token punctuation">.</span><span class="token function">StreamInterceptor</span><span class="token punctuation">(</span>authInterceptor<span class="token punctuation">.</span><span class="token function">Stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>修改客户端启动函数：</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">loadTLSCredentials</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>credentials<span class="token punctuation">.</span>TransportCredentials<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	pemServerCA<span class="token punctuation">,</span> err <span class="token operator">:=</span> ioutil<span class="token punctuation">.</span><span class="token function">ReadFile</span><span class="token punctuation">(</span><span class="token string">&quot;ssl/ca-cert.pem&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
	<span class="token punctuation">}</span>
	certPool <span class="token operator">:=</span> x509<span class="token punctuation">.</span><span class="token function">NewCertPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>certPool<span class="token punctuation">.</span><span class="token function">AppendCertsFromPEM</span><span class="token punctuation">(</span>pemServerCA<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to add server CA&#39;s certificate&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	config <span class="token operator">:=</span> <span class="token operator">&amp;</span>tls<span class="token punctuation">.</span>Config<span class="token punctuation">{</span>
		RootCAs<span class="token punctuation">:</span> certPool<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> credentials<span class="token punctuation">.</span><span class="token function">NewTLS</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
tlsCredentials<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">loadTLSCredentials</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
	log<span class="token punctuation">.</span><span class="token function">Fatalln</span><span class="token punctuation">(</span><span class="token string">&quot;cannot load TLS credentials:&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
conn<span class="token punctuation">,</span> err <span class="token operator">:=</span> grpc<span class="token punctuation">.</span><span class="token function">Dial</span><span class="token punctuation">(</span><span class="token operator">*</span>serverAddress<span class="token punctuation">,</span> grpc<span class="token punctuation">.</span><span class="token function">WithTransportCredentials</span><span class="token punctuation">(</span>tlsCredentials<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h3 id="双端认证" tabindex="-1"><a class="header-anchor" href="#双端认证" aria-hidden="true">#</a> 双端认证</h3><p>修改服务端启动函数：</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">loadTLSCredentials</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>credentials<span class="token punctuation">.</span>TransportCredentials<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	serverCert<span class="token punctuation">,</span> err <span class="token operator">:=</span> tls<span class="token punctuation">.</span><span class="token function">LoadX509KeyPair</span><span class="token punctuation">(</span><span class="token string">&quot;ssl/server-cert.pem&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;ssl/server-key.pem&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
	<span class="token punctuation">}</span>
  <span class="token comment">// 这里添加 CA 相关。</span>
	pemClientCA<span class="token punctuation">,</span> err <span class="token operator">:=</span> ioutil<span class="token punctuation">.</span><span class="token function">ReadFile</span><span class="token punctuation">(</span><span class="token string">&quot;ssl/ca-cert.pem&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
	<span class="token punctuation">}</span>
	certPool <span class="token operator">:=</span> x509<span class="token punctuation">.</span><span class="token function">NewCertPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>certPool<span class="token punctuation">.</span><span class="token function">AppendCertsFromPEM</span><span class="token punctuation">(</span>pemClientCA<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to add client CA&#39;s certificate&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	config <span class="token operator">:=</span> <span class="token operator">&amp;</span>tls<span class="token punctuation">.</span>Config<span class="token punctuation">{</span>
    <span class="token comment">// 结构体内成员修改。</span>
		Certificates<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>tls<span class="token punctuation">.</span>Certificate<span class="token punctuation">{</span>serverCert<span class="token punctuation">}</span><span class="token punctuation">,</span>
		ClientAuth<span class="token punctuation">:</span> tls<span class="token punctuation">.</span>RequireAndVerifyClientCert<span class="token punctuation">,</span>
		ClientCAs<span class="token punctuation">:</span> certPool<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> credentials<span class="token punctuation">.</span><span class="token function">NewTLS</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>修改客户端启动函数：</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">loadTLSCredentials</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>credentials<span class="token punctuation">.</span>TransportCredentials<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	pemServerCA<span class="token punctuation">,</span> err <span class="token operator">:=</span> ioutil<span class="token punctuation">.</span><span class="token function">ReadFile</span><span class="token punctuation">(</span><span class="token string">&quot;ssl/ca-cert.pem&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
	<span class="token punctuation">}</span>
	certPool <span class="token operator">:=</span> x509<span class="token punctuation">.</span><span class="token function">NewCertPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>certPool<span class="token punctuation">.</span><span class="token function">AppendCertsFromPEM</span><span class="token punctuation">(</span>pemServerCA<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to add server CA&#39;s certificate&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
  <span class="token comment">// 修改，添加客户端证书、密钥。</span>
	clientCert<span class="token punctuation">,</span> err <span class="token operator">:=</span> tls<span class="token punctuation">.</span><span class="token function">LoadX509KeyPair</span><span class="token punctuation">(</span><span class="token string">&quot;ssl/client-cert.pem&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;ssl/client-key.pem&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
	<span class="token punctuation">}</span>
	config <span class="token operator">:=</span> <span class="token operator">&amp;</span>tls<span class="token punctuation">.</span>Config<span class="token punctuation">{</span>
    <span class="token comment">// 修改</span>
		Certificates<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>tls<span class="token punctuation">.</span>Certificate<span class="token punctuation">{</span>clientCert<span class="token punctuation">}</span><span class="token punctuation">,</span>
		RootCAs<span class="token punctuation">:</span> certPool<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> credentials<span class="token punctuation">.</span><span class="token function">NewTLS</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h2 id="load-balance" tabindex="-1"><a class="header-anchor" href="#load-balance" aria-hidden="true">#</a> Load Balance</h2><h3 id="no-tls" tabindex="-1"><a class="header-anchor" href="#no-tls" aria-hidden="true">#</a> NO TLS</h3><p>修改 Nginx 配置文件：</p><div class="language-conf ext-conf line-numbers-mode"><pre class="language-conf"><code>worker_processes auto;
error_log /var/log/nginx/error.log;
events {
	worker_connections 768;
}

http {
	access_log /var/log/nginx/access.log;

	upstream hello_services {
		server 0.0.0.0:8081;
		server 0.0.0.0:8082;
	}

	server {
		listen	80 http2;
		location / {
			grpc_pass grpc://hello_services;
		}
	}
}
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>将 gRPC 服务端启动在对应的端口即可，访问 Nginx 监听的 80 端口即可访问 gRPC 的接口。</p><h3 id="tls" tabindex="-1"><a class="header-anchor" href="#tls" aria-hidden="true">#</a> TLS</h3><p>TODO</p><h2 id="grpc-gateway" tabindex="-1"><a class="header-anchor" href="#grpc-gateway" aria-hidden="true">#</a> gRPC Gateway</h2><h3 id="安装工具" tabindex="-1"><a class="header-anchor" href="#安装工具" aria-hidden="true">#</a> 安装工具</h3><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>go <span class="token function">install</span> github.com/grpc-ecosystem/grpc-gateway/v2/protoc-gen-grpc-gateway@latest
go <span class="token function">install</span> github.com/grpc-ecosystem/grpc-gateway/v2/protoc-gen-openapiv2@latest
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="在服务-proto-文件中定义" tabindex="-1"><a class="header-anchor" href="#在服务-proto-文件中定义" aria-hidden="true">#</a> 在服务 proto 文件中定义</h3><p>首先定义一个简单的服务：</p><div class="language-protobuf ext-protobuf line-numbers-mode"><pre class="language-protobuf"><code><span class="token keyword">syntax</span> <span class="token operator">=</span> <span class="token string">&quot;proto3&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">option</span> go_package <span class="token operator">=</span> <span class="token string">&quot;./;pb&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">message</span> <span class="token class-name">HelloWorldRequest</span> <span class="token punctuation">{</span>
  <span class="token builtin">string</span> msg <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">message</span> <span class="token class-name">HelloWorldResponse</span> <span class="token punctuation">{</span>
  <span class="token builtin">string</span> msg <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><div class="language-protobuf ext-protobuf line-numbers-mode"><pre class="language-protobuf"><code><span class="token keyword">syntax</span> <span class="token operator">=</span> <span class="token string">&quot;proto3&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">option</span> go_package <span class="token operator">=</span> <span class="token string">&quot;./;pb&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token string">&quot;proto/hello.proto&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string">&quot;google/api/annotations.proto&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">service</span> <span class="token class-name">HelloService</span> <span class="token punctuation">{</span>
  <span class="token keyword">rpc</span> <span class="token function">HelloWorld</span><span class="token punctuation">(</span><span class="token class-name">HelloWorldRequest</span><span class="token punctuation">)</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token class-name">HelloWorldResponse</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">option</span> <span class="token punctuation">(</span>google<span class="token punctuation">.</span>api<span class="token punctuation">.</span>http<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
      post<span class="token punctuation">:</span> <span class="token string">&quot;/v1/example/echo/{msg}&quot;</span> <span class="token comment">// 绑定请求方法和请求路径</span>
      body<span class="token punctuation">:</span> <span class="token string">&quot;*&quot;</span>
      additional_bindings <span class="token punctuation">{</span> <span class="token comment">// 绑定其他请求方式和路径</span>
        get<span class="token punctuation">:</span> <span class="token string">&quot;/v1/get&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><div class="custom-container warning"><p class="custom-container-title">注意</p><p>这种方式需要将 <a href="https://github.com/googleapis/googleapis" target="_blank" rel="noopener noreferrer"><code>googleapis</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a> <code>google/api</code> 目录中的几个文件拷贝到项目中：<code>annotations.proto</code>、<code>field_behavior.proto</code>、<code>httpbody.proto</code>、<code>http.proto</code>。</p></div><p>执行编译命令：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>protoc -I <span class="token builtin class-name">.</span> --go_out<span class="token operator">=</span>pb --go-grpc_out<span class="token operator">=</span>pb --grpc-gateway_out pb --grpc-gateway_opt <span class="token assign-left variable">logtostderr</span><span class="token operator">=</span>true  proto/*.proto
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>实现所有的接口，最终项目文件结构：</p><p><img src="/grpc-and-protobuf/项目文件结构.png" alt="项目文件结构"></p><p>其中的 <code>api.yaml</code> 是另一种 grpc-gateway 的使用方式，这里先不考虑。</p><p>main.go：</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;context&quot;</span>
	<span class="token string">&quot;log&quot;</span>
	<span class="token string">&quot;net&quot;</span>
	<span class="token string">&quot;net/http&quot;</span>
	<span class="token string">&quot;proto/pb&quot;</span>
	<span class="token string">&quot;proto/service&quot;</span>

	<span class="token string">&quot;github.com/grpc-ecosystem/grpc-gateway/v2/runtime&quot;</span>
	<span class="token string">&quot;google.golang.org/grpc&quot;</span>
	<span class="token string">&quot;google.golang.org/grpc/credentials/insecure&quot;</span>
	<span class="token string">&quot;google.golang.org/grpc/reflection&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">startHttpServer</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	mux <span class="token operator">:=</span> runtime<span class="token punctuation">.</span><span class="token function">NewServeMux</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	err <span class="token operator">:=</span> pb<span class="token punctuation">.</span><span class="token function">RegisterHelloServiceHandlerFromEndpoint</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> mux<span class="token punctuation">,</span> <span class="token string">&quot;localhost:8082&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>grpc<span class="token punctuation">.</span>DialOption<span class="token punctuation">{</span>grpc<span class="token punctuation">.</span><span class="token function">WithTransportCredentials</span><span class="token punctuation">(</span>insecure<span class="token punctuation">.</span><span class="token function">NewCredentials</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;RegisterHelloServiceHandlerFromEndpoint failed:&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	http<span class="token punctuation">.</span><span class="token function">ListenAndServe</span><span class="token punctuation">(</span><span class="token string">&quot;:8081&quot;</span><span class="token punctuation">,</span> mux<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">startgRPCServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	grpcServer <span class="token operator">:=</span> grpc<span class="token punctuation">.</span><span class="token function">NewServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	helloServer <span class="token operator">:=</span> service<span class="token punctuation">.</span>HelloService<span class="token punctuation">{</span><span class="token punctuation">}</span>
	pb<span class="token punctuation">.</span><span class="token function">RegisterHelloServiceServer</span><span class="token punctuation">(</span>grpcServer<span class="token punctuation">,</span> helloServer<span class="token punctuation">)</span>
	reflection<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>grpcServer<span class="token punctuation">)</span>
	listener<span class="token punctuation">,</span> err <span class="token operator">:=</span> net<span class="token punctuation">.</span><span class="token function">Listen</span><span class="token punctuation">(</span><span class="token string">&quot;tcp&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;:8082&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
		log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;start server failed&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	err <span class="token operator">=</span> grpcServer<span class="token punctuation">.</span><span class="token function">Serve</span><span class="token punctuation">(</span>listener<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;start grpc server failed&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">go</span> <span class="token function">startHttpServer</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token function">startgRPCServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br></div></div><p>其中的 <code>RegisterHelloServiceHandlerFromEndpoint</code> 方法可以用来转换包括流式 gRPC 的类型，需要指定 gRPC 服务端的路径；如果只有一元 gRPC 可以使用 <code>RegisterHelloServiceHandlerServer</code> 方法，这个方法不需要指定 gRPC 服务端的路径，同时使用这个方法也不需要额外启动 gRPC 服务端。</p><h3 id="在-yaml-配置文件中定义" tabindex="-1"><a class="header-anchor" href="#在-yaml-配置文件中定义" aria-hidden="true">#</a> 在 YAML 配置文件中定义</h3><p>定义 <code>api.yaml</code> 文件：</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">type</span><span class="token punctuation">:</span> google.api.Service
<span class="token key atrule">config_version</span><span class="token punctuation">:</span> <span class="token number">3</span>

<span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token key atrule">rules</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">selector</span><span class="token punctuation">:</span> HelloService.HelloWorld
      <span class="token key atrule">post</span><span class="token punctuation">:</span> /v1/example/echo
      <span class="token key atrule">body</span><span class="token punctuation">:</span> <span class="token string">&quot;*&quot;</span>
      <span class="token key atrule">additional_bindings</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">get</span><span class="token punctuation">:</span> /v1/example/echo
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p><a href="https://cloud.google.com/endpoints/docs/grpc-service-config/reference/rpc/google.api#special-notes" target="_blank" rel="noopener noreferrer">配置参考<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a>，使用 YAML 和直接在 proto 文件中定义都可以参考这里的配置。</p><p>其他代码不需要改动，执行编译命令后直接运行：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>protoc -I <span class="token builtin class-name">.</span> --go_out<span class="token operator">=</span>pb --go-grpc_out pb --grpc-gateway_out pb --grpc-gateway_opt <span class="token assign-left variable">logtostderr</span><span class="token operator">=</span>true --grpc-gateway_opt <span class="token assign-left variable">grpc_api_configuration</span><span class="token operator">=</span>proto/api.yaml proto/*.proto
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><h3 id="tls-1" tabindex="-1"><a class="header-anchor" href="#tls-1" aria-hidden="true">#</a> TLS</h3><p>TODO</p><h2 id="结合自定义-tag-实现-validate" tabindex="-1"><a class="header-anchor" href="#结合自定义-tag-实现-validate" aria-hidden="true">#</a> 结合自定义 tag 实现 validate</h2><p>首先定义下面这样一个请求：</p><div class="language-protobuf ext-protobuf line-numbers-mode"><pre class="language-protobuf"><code><span class="token keyword">message</span> <span class="token class-name">DemoRequest</span><span class="token punctuation">{</span>
  <span class="token builtin">string</span> id <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// @gotags: valid:&quot;required,objectId&quot;</span>
  <span class="token builtin">string</span> status <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token comment">// @gotags: valid:&quot;in(succeed|failed|processing),required&quot;</span>
  <span class="token keyword">repeated</span> <span class="token builtin">string</span> ids <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token comment">// @gotags: valid:&quot;required,objectIdList&quot;</span>
  <span class="token builtin">bool</span> containDeleted <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
  <span class="token builtin">int64</span> option <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>这里我们使用一个 <a href="https://github.com/asaskevich/govalidator" target="_blank" rel="noopener noreferrer">govalidator<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a> 库：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>go get github.com/asaskevich/govalidator
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>这个库本身具有一些内置的规则，可以在文档中找到，这里我们实现自定义验证，调用 <code>govalidator.CustomTypeTagMap.Set</code> 方法可以自定义验证：</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// govalidator.TagMap[&quot;objectId&quot;] = govalidator.Validator(func(str string) bool {</span>
	<span class="token comment">// 	_, err := primitive.ObjectIDFromHex(str)</span>
	<span class="token comment">// 	return err == nil</span>
	<span class="token comment">// })</span>

	govalidator<span class="token punctuation">.</span>CustomTypeTagMap<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">&quot;objectId&quot;</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> o <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
		s <span class="token operator">:=</span> cast<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
		<span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> primitive<span class="token punctuation">.</span><span class="token function">ObjectIDFromHex</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
		<span class="token keyword">return</span> err <span class="token operator">==</span> <span class="token boolean">nil</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>

	govalidator<span class="token punctuation">.</span>CustomTypeTagMap<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">&quot;objectIdList&quot;</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> o <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
		strs <span class="token operator">:=</span> cast<span class="token punctuation">.</span><span class="token function">ToStringSlice</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
		<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> str <span class="token operator">:=</span> <span class="token keyword">range</span> strs <span class="token punctuation">{</span>
			<span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> primitive<span class="token punctuation">.</span><span class="token function">ObjectIDFromHex</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span>
			<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
				<span class="token keyword">return</span> <span class="token boolean">false</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> <span class="token boolean">true</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><div class="custom-container tip"><p class="custom-container-title">TIP</p><p>注释中的方法也可以用来自定义规则，但是只适用于单一字符串验证，如果是数组或者其他类型还是不够灵活。</p></div><p>接下来我们在接口实现中调用验证方法验证请求即可：</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>ValidatorService<span class="token punctuation">)</span> <span class="token function">Demo</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> req <span class="token operator">*</span>proto<span class="token punctuation">.</span>DemoRequest<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>proto<span class="token punctuation">.</span>EmptyResponse<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> govalidator<span class="token punctuation">.</span><span class="token function">ValidateStruct</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>proto<span class="token punctuation">.</span>EmptyResponse<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><!--]--></div><footer class="page-meta"><!----><div class="meta-item last-updated"><span class="meta-item-label">Last Updated: </span><!----></div><div class="meta-item contributors"><span class="meta-item-label">Contributors: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: 1658272229@com请求">PPG007</span><!--[-->, <!--]--><!--]--><!--[--><span class="contributor" title="email: koston.zhuang@maiscrm.com">Koston Zhuang</span><!--[-->, <!--]--><!--]--><!--[--><span class="contributor" title="email: 1658272229@qq.com">PPG007</span><!----><!--]--><!--]--></span></div></footer><nav class="page-nav"><p class="inner"><span class="prev"><a href="/grpc-and-protobuf/docs/protobuf.html" class="nav-link" aria-label="ProtoBuf"><!--[--><!--]--> ProtoBuf <!--[--><!--]--></a></span><!----></p></nav><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script type="module" src="/assets/app.269ed0ef.js" defer></script>
  </body>
</html>
